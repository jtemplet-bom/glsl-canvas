!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=6)}([function(e,t,n){"use strict";(function(e){var t=n(2),r=setTimeout;function i(e){return Boolean(e&&void 0!==e.length)}function o(){}function a(e){if(!(this instanceof a))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],h(e,this)}function s(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,a._immediateFn((function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null!==n){var r;try{r=n(e._value)}catch(e){return void l(t.promise,e)}u(t.promise,r)}else(1===e._state?u:l)(t.promise,e._value)}))):e._deferreds.push(t)}function u(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if(t instanceof a)return e._state=3,e._value=t,void f(e);if("function"==typeof n)return void h((r=n,i=t,function(){r.apply(i,arguments)}),e)}e._state=1,e._value=t,f(e)}catch(t){l(e,t)}var r,i}function l(e,t){e._state=2,e._value=t,f(e)}function f(e){2===e._state&&0===e._deferreds.length&&a._immediateFn((function(){e._handled||a._unhandledRejectionFn(e._value)}));for(var t=0,n=e._deferreds.length;t<n;t++)s(e,e._deferreds[t]);e._deferreds=null}function c(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}function h(e,t){var n=!1;try{e((function(e){n||(n=!0,u(t,e))}),(function(e){n||(n=!0,l(t,e))}))}catch(e){if(n)return;n=!0,l(t,e)}}a.prototype.catch=function(e){return this.then(null,e)},a.prototype.then=function(e,t){var n=new this.constructor(o);return s(this,new c(e,t,n)),n},a.prototype.finally=t.a,a.all=function(e){return new a((function(t,n){if(!i(e))return n(new TypeError("Promise.all accepts an array"));var r=Array.prototype.slice.call(e);if(0===r.length)return t([]);var o=r.length;function a(e,i){try{if(i&&("object"==typeof i||"function"==typeof i)){var s=i.then;if("function"==typeof s)return void s.call(i,(function(t){a(e,t)}),n)}r[e]=i,0==--o&&t(r)}catch(e){n(e)}}for(var s=0;s<r.length;s++)a(s,r[s])}))},a.resolve=function(e){return e&&"object"==typeof e&&e.constructor===a?e:new a((function(t){t(e)}))},a.reject=function(e){return new a((function(t,n){n(e)}))},a.race=function(e){return new a((function(t,n){if(!i(e))return n(new TypeError("Promise.race accepts an array"));for(var r=0,o=e.length;r<o;r++)a.resolve(e[r]).then(t,n)}))},a._immediateFn="function"==typeof e&&function(t){e(t)}||function(e){r(e,0)},a._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)}}).call(this,n(3).setImmediate)},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";t.a=function(e){var t=this.constructor;return this.then((function(n){return t.resolve(e()).then((function(){return n}))}),(function(n){return t.resolve(e()).then((function(){return t.reject(n)}))}))}},function(e,t,n){(function(e){var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,i=Function.prototype.apply;function o(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new o(i.call(setTimeout,r,arguments),clearTimeout)},t.setInterval=function(){return new o(i.call(setInterval,r,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(r,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},n(4),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(1))},function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var r,i,o,a,s,u=1,l={},f=!1,c=e.document,h=Object.getPrototypeOf&&Object.getPrototypeOf(e);h=h&&h.setTimeout?h:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick((function(){d(e)}))}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?e.MessageChannel?((o=new MessageChannel).port1.onmessage=function(e){d(e.data)},r=function(e){o.port2.postMessage(e)}):c&&"onreadystatechange"in c.createElement("script")?(i=c.documentElement,r=function(e){var t=c.createElement("script");t.onreadystatechange=function(){d(e),t.onreadystatechange=null,i.removeChild(t),t=null},i.appendChild(t)}):r=function(e){setTimeout(d,0,e)}:(a="setImmediate$"+Math.random()+"$",s=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(a)&&d(+t.data.slice(a.length))},e.addEventListener?e.addEventListener("message",s,!1):e.attachEvent("onmessage",s),r=function(t){e.postMessage(a+t,"*")}),h.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var i={callback:e,args:t};return l[u]=i,r(u),u++},h.clearImmediate=v}function v(e){delete l[e]}function d(e){if(f)setTimeout(d,0,e);else{var t=l[e];if(t){f=!0;try{!function(e){var t=e.callback,r=e.args;switch(r.length){case 0:t();break;case 1:t(r[0]);break;case 2:t(r[0],r[1]);break;case 3:t(r[0],r[1],r[2]);break;default:t.apply(n,r)}}(t)}finally{v(e),f=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(1),n(5))},function(e,t){var n,r,i=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function s(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:a}catch(e){r=a}}();var u,l=[],f=!1,c=-1;function h(){f&&u&&(f=!1,u.length?l=u.concat(l):c=-1,l.length&&v())}function v(){if(!f){var e=s(h);f=!0;for(var t=l.length;t;){for(u=l,l=[];++c<t;)u&&u[c].run();c=-1,t=l.length}u=null,f=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===a||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function m(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new d(e,t)),1!==l.length||f||s(v)},d.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t,n){"use strict";n.r(t),n.d(t,"GlslCanvasOptions",(function(){return Se})),n.d(t,"GlslCanvasTimer",(function(){return Pe})),n.d(t,"default",(function(){return Oe}));n(0);function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,i;return t=e,i=[{key:"fetch",value:function(e){return new Promise((function(t,n){var r=new XMLHttpRequest;r.onload=function(){t(r.response||r.responseText)},r.onerror=function(t){n(new Error("Network request failed for url ".concat(e)))},r.ontimeout=function(t){n(new Error("Network request failed for url ".concat(e)))},r.onabort=function(){n(new Error("Aborted"))},r.open("GET",e,!0),r.send(null)}))}}],(n=null)&&r(t.prototype,n),i&&r(t,i),e}();function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a,s,u,l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"log",value:function(){var t;e.enabled&&(t=console).log.apply(t,arguments)}},{key:"warn",value:function(){var t;e.enabled&&(t=console).warn.apply(t,arguments)}},{key:"error",value:function(){var t;e.enabled&&(t=console).error.apply(t,arguments)}}],(n=null)&&o(t.prototype,n),r&&o(t,r),e}();function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}u=!1,(s="enabled")in(a=l)?Object.defineProperty(a,s,{value:u,enumerable:!0,configurable:!0,writable:!0}):a[s]=u;var v,d,m="\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvoid main(){\n\tgl_FragColor = vec4(0.0);\n}\n",p=function e(){c(this,e),h(this,"alpha",void 0),h(this,"antialias",void 0),h(this,"depth",void 0),h(this,"failIfMajorPerformanceCaveat",void 0),h(this,"premultipliedAlpha",void 0),h(this,"preserveDrawingBuffer",void 0),h(this,"stencil",void 0)};!function(e){e[e.WebGl=1]="WebGl",e[e.WebGl2=2]="WebGl2"}(v||(v={})),function(e){e[e.BrowserSupport=1]="BrowserSupport",e[e.Other=2]="Other"}(d||(d={}));var g=function e(){c(this,e),h(this,"texcoord",void 0),h(this,"position",void 0)},y=function(){function e(){c(this,e)}var t,n,r;return t=e,r=[{key:"getContext_",value:function(e,t){for(var n=["webgl","experimental-webgl"],r=null,i=0;i<n.length;++i)try{r=e.getContext(n[i],t)}catch(e){if(r)break}return r}},{key:"getContext2_",value:function(e,t){var n=null;try{n=e.getContext("webgl2",t)}catch(e){}return n}},{key:"getIncludes",value:function(e){if(void 0===e)return Promise.resolve(e);for(var t,n=/#include\s*['|"](.*.glsl)['|"]/gm,r=[],o=0;null!==(t=n.exec(e));)r.push(Promise.resolve(e.slice(o,t.index))),o=t.index+t[0].length,r.push(i.fetch(t[1]));return r.push(Promise.resolve(e.slice(o))),Promise.all(r).then((function(e){return e.join("")}))}},{key:"isWebGl",value:function(e){return e instanceof WebGLRenderingContext}},{key:"isWebGl2",value:function(e){return window.WebGL2RenderingContext&&e instanceof WebGL2RenderingContext}},{key:"inferVersion",value:function(e,t){var n=e||t;return n&&0===n.indexOf("#version 300 es")?v.WebGl2:v.WebGl}},{key:"versionDiffers",value:function(t,n,r){if(t){var i=this.isWebGl2(t)?v.WebGl2:v.WebGl;return e.inferVersion(n,r)!==i}return!1}},{key:"getVertex",value:function(e,t){return e||(this.inferVersion(e,t)===v.WebGl2?"#version 300 es\n\nin vec2 a_position;\nin vec2 a_texcoord;\n\nout vec2 v_texcoord;\n\nvoid main() {\n\tgl_Position = vec4(a_position, 0.0, 1.0);\n\tv_texcoord = a_texcoord;\n}\n":"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nvarying vec2 v_texcoord;\n\nvoid main(){\n\tgl_Position = vec4(a_position, 0.0, 1.0);\n\tv_texcoord = a_texcoord;\n}\n")}},{key:"getFragment",value:function(e,t){return t||(this.inferVersion(e,t)===v.WebGl2?"#version 300 es\n\nprecision mediump float;\n\nout vec4 outColor;\n\nvoid main() {\n\toutColor = vec4(0.0);\n}\n":m)}},{key:"tryInferContext",value:function(t,n,r,i,o){function a(e,t){if("function"==typeof o)o(e);else{var n=r.parentNode;n&&(n.innerHTML='<div class="glsl-canvas--error">'.concat(t,"</div>"))}}if(WebGLRenderingContext){var s=e.inferContext(t,n,r,i);return s?this.isWebGl2(s)||s.getExtension("OES_standard_derivatives"):a(d.Other,'It does not appear your computer can support WebGL.<br/>\n\t\t\t<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>'),s}a(d.BrowserSupport,'This page requires a browser that supports WebGL.<br/>\n\t\t\t<a href="http://get.webgl.org">Click here to upgrade your browser.</a>')}},{key:"tryGetContext",value:function(t,n,r){function i(e,n){if("function"==typeof r)r(e);else{var i=t.parentNode;i&&(i.innerHTML='<div class="glsl-canvas--error">'.concat(n,"</div>"))}}if(!WebGLRenderingContext)return i(d.BrowserSupport,'This page requires a browser that supports WebGL.<br/>\n\t\t\t<a href="http://get.webgl.org">Click here to upgrade your browser.</a>'),null;var o=e.getContext_(t,n);return o?o.getExtension("OES_standard_derivatives"):i(d.Other,'It does not appear your computer can support WebGL.<br/>\n\t\t\t<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>'),o}},{key:"inferContext",value:function(e,t,n,r){return this.inferVersion(e,t)===v.WebGl2?this.getContext2_(n,r):this.getContext_(n,r)}},{key:"createShader",value:function(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=t.createShader(r);t.shaderSource(o,n),t.compileShader(o);var a=t.getShaderParameter(o,t.COMPILE_STATUS);if(!a)throw e.lastError=t.getShaderInfoLog(o),l.error("*** Error compiling shader "+o+":"+e.lastError),t.deleteShader(o),{shader:o,source:n,type:r,error:e.lastError,offset:i};return o}},{key:"createProgram",value:function(t,n,r,i){for(var o=t.createProgram(),a=0;a<n.length;++a)t.attachShader(o,n[a]);if(r&&i)for(var s=0;s<r.length;++s)t.bindAttribLocation(o,i?i[s]:s,r[s]);return t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)?o:(e.lastError=t.getProgramInfoLog(o),l.log("Error in program linking:"+e.lastError),t.deleteProgram(o),null)}},{key:"createVertexBuffers",value:function(e,t){var n=new g,r=e.getAttribLocation(t,"a_texcoord");n.texcoord=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.texcoord),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(r),e.vertexAttribPointer(r,2,e.FLOAT,!1,0,0);var i=e.getAttribLocation(t,"a_position");return n.position=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.position),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),n}}],(n=null)&&f(t.prototype,n),r&&f(t,r),e}();function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function E(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}h(y,"lastError","");var T=function e(){E(this,e)},_=function(){function e(){E(this,e),function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(this,"values",new T)}var t,n,r;return t=e,(n=[{key:"has",value:function(e){return this.values.hasOwnProperty(e)}},{key:"set",value:function(e,t){this.values[e]=t}},{key:"get",value:function(e){return this.values[e]}},{key:"forEach",value:function(e){var t=0;for(var n in this.values)e(this.values[n],t,this.values),t++}},{key:"reduce",value:function(e,t){var n=t,r=0;for(var i in this.values)n=e(n,this.values[i],r,this.values),r++;return n}}])&&b(t.prototype,n),r&&b(t,r),e}();function w(e){return(w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function x(e,t){return!t||"object"!==w(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function k(e){return(k=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function A(e,t){return(A=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function U(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function R(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function L(e,t,n){return t&&R(e.prototype,t),n&&R(e,n),e}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var P;!function(e){e[e.FLOAT=0]="FLOAT",e[e.HALF_FLOAT=1]="HALF_FLOAT"}(P||(P={}));var O=function(){function e(t,n,r,i){U(this,e),S(this,"texture",void 0),S(this,"buffer",void 0),S(this,"BW",void 0),S(this,"BH",void 0),S(this,"index",void 0);var o=t.createFramebuffer(),a=this.getTexture(t,n,r,i);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.texture=a,this.buffer=o,this.BW=n,this.BH=r,this.index=i}return L(e,[{key:"getFloatType",value:function(t){var n,r;if(e.floatType===P.FLOAT){var i=y.isWebGl2(t)?"EXT_color_buffer_float":"OES_texture_float";if(!(r=t.getExtension(i)))return e.floatType=P.HALF_FLOAT,this.getFloatType(t);n=t.FLOAT}else{var o=y.isWebGl2(t)?"EXT_color_buffer_half_float":"OES_texture_half_float";if(!(r=t.getExtension(o)))return e.floatType=P.FLOAT,this.getFloatType(t);n=r.HALF_FLOAT_OES}return n}},{key:"getTexture",value:function(t,n,r,i){var o=this.getFloatType(t),a=t.createTexture();return t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,a),t.texImage2D(t.TEXTURE_2D,0,y.isWebGl2(t)?t.RGBA16F:t.RGBA,n,r,0,t.RGBA,o,null),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE?(e.floatType===P.FLOAT?e.floatType=P.HALF_FLOAT:e.floatType=P.FLOAT,this.getTexture(t,n,r,i)):a}},{key:"resize",value:function(e,t,n){if(t!==this.BW||n!==this.BH){var r=this.buffer,i=this.texture,o=this.index;e.bindFramebuffer(e.FRAMEBUFFER,r);var a,s=e.checkFramebufferStatus(e.FRAMEBUFFER),u=Math.min(t,this.BW),l=Math.min(n,this.BH),f=this.getFloatType(e);s===e.FRAMEBUFFER_COMPLETE&&(a=new Float32Array(u*l*4),e.readPixels(0,0,u,l,e.RGBA,f,a)),e.bindFramebuffer(e.FRAMEBUFFER,null);var c=o+1,h=this.getTexture(e,t,n,c);f=this.getFloatType(e),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),a&&e.texSubImage2D(e.TEXTURE_2D,0,0,0,u,l,e.RGBA,f,a);var v=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteTexture(i),e.activeTexture(e.TEXTURE0+o),e.bindTexture(e.TEXTURE_2D,h),this.index=o,this.texture=h,this.buffer=v,this.BW=t,this.BH=n}}}]),e}();S(O,"floatType",P.HALF_FLOAT);var F=function(){function e(t,n,r,i){U(this,e),S(this,"program",void 0),S(this,"input",void 0),S(this,"output",void 0),S(this,"index",void 0),S(this,"key",void 0),S(this,"vertexString",void 0),S(this,"fragmentString",void 0),S(this,"BW",void 0),S(this,"BH",void 0),S(this,"isValid",!1),this.index=t,this.key=n,this.vertexString=r,this.fragmentString=i}return L(e,[{key:"create",value:function(e,t,n){var r=y.createShader(e,this.vertexString,e.VERTEX_SHADER),i=y.createShader(e,this.fragmentString,e.FRAGMENT_SHADER,1);i?this.isValid=!0:(i=y.createShader(e,y.isWebGl2(e)?"#version 300 es\n\nprecision mediump float;\n\nout vec4 outColor;\n\nvoid main() {\n\toutColor = vec4(1.0);\n}\n":"\nvoid main(){\n\tgl_FragColor = vec4(1.0);\n}",e.FRAGMENT_SHADER),this.isValid=!1);var o=y.createProgram(e,[r,i]);e.linkProgram(o);var a=new O(e,t,n,this.index+0),s=new O(e,t,n,this.index+2);this.program=o,this.input=a,this.output=s,e.deleteShader(r),e.deleteShader(i)}},{key:"render",value:function(e,t,n){e.useProgram(this.program),e.viewport(0,0,t,n),e.bindFramebuffer(e.FRAMEBUFFER,this.output.buffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.output.texture,0),e.drawArrays(e.TRIANGLES,0,6);var r=this.input,i=this.output;this.input=i,this.output=r}},{key:"resize",value:function(e,t,n){e.useProgram(this.program),e.viewport(0,0,t,n),this.input.resize(e,t,n),this.output.resize(e,t,n)}},{key:"destroy",value:function(e){e.deleteProgram(this.program),this.program=null,this.input=null,this.output=null}}]),e}(),M=function(e){function t(){return U(this,t),x(this,k(t).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&A(e,t)}(t,e),L(t,[{key:"count",get:function(){return 4*Object.keys(this.values).length}}],[{key:"getBuffers",value:function(e,n,r){var i=new t,o=0;if(n){y.isWebGl2(e)&&(n=n.replace(/^\#version\s*300\s*es\s*\n/,""));for(var a,s=/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*BUFFER_)(\d+)(?:\s*\))|(?:#ifdef)(?:\s*BUFFER_)(\d+)(?:\s*))/gm;null!==(a=s.exec(n));){var u=a[3]||a[4],l="u_buffer"+u,f=y.isWebGl2(e)?"#version 300 es\n#define BUFFER_".concat(u,"\n").concat(n):"#define BUFFER_".concat(u,"\n").concat(n),c=new F(o,l,r,f);c.create(e,e.drawingBufferWidth,e.drawingBufferHeight),i.set(l,c),o+=4}}return i}}]),t}(_);function C(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function I(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function D(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var B=function e(t,n){I(this,e),D(this,"event",void 0),D(this,"callback",void 0),this.event=t,this.callback=n},G=function(){function e(){I(this,e),D(this,"listeners",new Set)}var t,n,r;return t=e,(n=[{key:"logListeners",value:function(){this.listeners.forEach((function(e){return l.log(e)}))}},{key:"subscribe",value:function(e){this.listeners.add(e)}},{key:"unsubscribe",value:function(e){this.listeners.delete(e)}},{key:"unsubscribeAll",value:function(){this.listeners.clear()}},{key:"on",value:function(e,t){return this.listeners.add(new B(e,t)),this}},{key:"off",value:function(e,t){var n=this;return t?this.listeners.delete(new B(e,t)):this.listeners.forEach((function(t){t.event===e&&n.listeners.delete(t)})),this}},{key:"trigger",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return this.listeners.forEach((function(t){t.event===e&&"function"==typeof t.callback&&t.callback.apply(t,n)})),this}}])&&C(t.prototype,n),r&&C(t,r),e}();function j(e){return(j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function X(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function W(e,t,n){return t&&X(e.prototype,t),n&&X(e,n),e}function N(e,t){return!t||"object"!==j(t)&&"function"!=typeof t?V(e):t}function H(e){return(H=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function V(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Y(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&q(e,t)}function q(e,t){return(q=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function z(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function K(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Q,$,J=["ogv","webm","mp4"];["jpg","jpeg","png"].concat(J);!function(e){e[e.Data=0]="Data",e[e.Element=1]="Element",e[e.Url=2]="Url"}(Q||(Q={})),function(e){e.MipMap="mipmap",e.Linear="linear",e.Nearest="nearest"}($||($={}));var Z,ee,te=function e(){z(this,e),K(this,"data",void 0),K(this,"width",void 0),K(this,"height",void 0)},ne=function(e){function t(e,n,r){var i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{filtering:$.Linear},a=arguments.length>4?arguments[4]:void 0;return z(this,t),K(V(i=N(this,H(t).call(this))),"key",void 0),K(V(i),"index",void 0),K(V(i),"options",void 0),K(V(i),"workpath",void 0),K(V(i),"width",void 0),K(V(i),"height",void 0),K(V(i),"texture",void 0),K(V(i),"source",void 0),K(V(i),"sourceType",void 0),K(V(i),"filtering",void 0),K(V(i),"url",void 0),K(V(i),"valid",!1),K(V(i),"dirty",!1),K(V(i),"animated",!1),K(V(i),"powerOf2",!1),i.key=n,i.index=r,i.options=o,i.workpath=a,i.create(e),i}return Y(t,e),W(t,[{key:"create",value:function(e){this.texture=e.createTexture(),this.texture&&(this.valid=!0),this.setData(e,1,1,new Uint8Array([0,0,0,0]),this.options)}},{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.options=t,"string"==typeof t.url?void 0===this.url||t.url!==this.url?this.setUrl(e,t.url,t):Promise.resolve(this):t.element?this.setElement(e,t.element,t):t.data&&t.width&&t.height?this.setData(e,t.width,t.height,t.data,t):void 0}},{key:"setUrl",value:function(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.valid){this.url=n,this.source=n,this.sourceType=Q.Url,this.options=Object.assign(this.options,r);var i,o,a=String(-1===n.indexOf(":/")&&void 0!==this.workpath?"".concat(this.workpath,"/").concat(n):n),s=n.split("?")[0].split(".").pop().toLowerCase(),u=-1!==J.indexOf(s);return u?(l.log("GlslCanvas.setUrl video",a),(i=document.createElement("video")).setAttribute("preload","auto"),i.setAttribute("loop","true"),i.setAttribute("muted","true"),i.setAttribute("playsinline","true"),i.loop=!0,i.muted=!0,o=this.setElement(e,i,r),i.src=a,i.addEventListener("canplay",(function(){i.play()}))):(l.log("GlslCanvas.setUrl image",a),i=document.createElement("img"),o=this.setElement(e,i,r),t.isSafari()&&"data:"===n.slice(0,5)||(i.crossOrigin="anonymous"),i.src=a),o}}},{key:"setElement",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r=this.options=Object.assign(this.options,r),new Promise((function(i,o){var a=t;if("string"==typeof t&&(t=document.querySelector(t)),t instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof HTMLVideoElement)if(n.source=t,n.sourceType=Q.Element,t instanceof HTMLVideoElement){var s=t;s.addEventListener("loadeddata",(function(t){n.update(e,r),n.setFiltering(e,r),i(n)})),s.addEventListener("error",(function(e){o(e)})),s.load()}else t instanceof HTMLImageElement?(t.addEventListener("load",(function(){n.update(e,r),n.setFiltering(e,r),i(n)})),t.addEventListener("error",(function(e){o(e)}))):(n.update(e,r),n.setFiltering(e,r),i(n));else{var u="the 'element' parameter (`element: ".concat(JSON.stringify(a),"`) must be a CSS selector string, or a <canvas>, <image> or <video> object");l.log("Texture '".concat(n.key,"': ").concat(u),r),o(u)}}))}},{key:"setData",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return this.width=t,this.height=n,this.options=Object.assign(this.options,i),this.source=r,this.sourceType=Q.Data,this.update(e,i),this.setFiltering(e,i),Promise.resolve(this)}},{key:"update",value:function(e,t){if(this.valid){if(e.activeTexture(e.TEXTURE0+this.index),e.bindTexture(e.TEXTURE_2D,this.texture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1===t.UNPACK_FLIP_Y_WEBGL?0:1),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.UNPACK_PREMULTIPLY_ALPHA_WEBGL||0),this.sourceType===Q.Element)this.source instanceof HTMLImageElement&&this.source.naturalWidth&&this.source.naturalHeight?(this.width=this.source.naturalWidth,this.height=this.source.naturalHeight,e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.source)):this.source instanceof HTMLVideoElement&&this.source.videoWidth&&this.source.videoHeight?(this.width=this.source.videoWidth,this.height=this.source.videoHeight,e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.source)):this.source instanceof HTMLCanvasElement&&(this.width=this.source.width,this.height=this.source.height,e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.source));else if(this.sourceType===Q.Data){var n=this.source;e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,n)}this.trigger("loaded",this)}}},{key:"tryUpdate",value:function(e){var t=!1;return this.animated&&(t=!0,this.update(e,this.options)),t}},{key:"destroy",value:function(e){this.valid&&(e.deleteTexture(this.texture),this.texture=null,delete this.source,this.source=null,this.valid=!1)}},{key:"setFiltering",value:function(e,n){if(this.valid){var r=t.isPowerOf2(this.width)&&t.isPowerOf2(this.height),i=n.filtering||$.MipMap,o=n.TEXTURE_WRAP_S||(n.repeat?e.REPEAT:e.CLAMP_TO_EDGE),a=n.TEXTURE_WRAP_T||(n.repeat?e.REPEAT:e.CLAMP_TO_EDGE);r||(i=i===$.MipMap?$.Linear:i,o=a=e.CLAMP_TO_EDGE,(n.repeat||n.TEXTURE_WRAP_S||n.TEXTURE_WRAP_T)&&l.warn("GlslCanvas: cannot repeat texture ".concat(n.url," cause is not power of 2."))),this.powerOf2=r,this.filtering=i,e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,a),this.filtering===$.MipMap?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.generateMipmap(e.TEXTURE_2D)):this.filtering===$.Nearest?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)):this.filtering===$.Linear&&(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR))}}}],[{key:"isPowerOf2",value:function(e){return 0==(e&e-1)}},{key:"isSafari",value:function(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}},{key:"isTextureUrl",value:function(e){return e&&/\.(jpg|jpeg|png|ogv|webm|mp4)$/i.test(e.split("?")[0])}},{key:"isTexture",value:function(e){return void 0!==t.getTextureOptions(e)}},{key:"getMaxTextureSize",value:function(e){return e.getParameter(e.MAX_TEXTURE_SIZE)}},{key:"getTextureOptions",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e&&""!==e){if(t.isTextureUrl(e))return n.url=e,-1!==e.indexOf("?")&&(n=e.split("?")[1].split("&").reduce((function(e,t){var n=t.split("="),r=decodeURIComponent(n[0]),i=decodeURIComponent(n[1]);switch(r){case"filtering":e[r]=i;break;case"repeat":case"UNPACK_FLIP_Y_WEBGL":e[r]=Boolean(i);break;case"UNPACK_PREMULTIPLY_ALPHA_WEBGL":case"TEXTURE_WRAP_S":case"TEXTURE_WRAP_T":e[r]=Number(i)}return e}),n)),n;document&&(e=document.querySelector(e))}return e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement?(n.element=e,n):e instanceof te?(n.data=e.data,n.width=e.width,n.height=e.height,n):void 0}}]),t}(G),re=function(e){function t(){var e,n;z(this,t);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return K(V(n=N(this,(e=H(t)).call.apply(e,[this].concat(i)))),"count",0),K(V(n),"dirty",!1),K(V(n),"animated",!1),n}return Y(t,e),W(t,[{key:"clean",value:function(){for(var e in this.values)this.values[e].dirty=!1;this.dirty=!1}},{key:"createOrUpdate",value:function(e,t,n){var r,i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},s=arguments.length>5?arguments[5]:void 0,u=ne.getTextureOptions(n,a);return(r=this.get(t))||(r=new ne(e,t,o+this.count,u,s),this.count++,this.set(t,r)),void 0!==u?r.load(e,u).then((function(t){if(t.source instanceof HTMLVideoElement){var n=t.source;n.addEventListener("play",(function(){t.animated=!0,i.animated=!0})),n.addEventListener("pause",(function(){t.animated=!1,i.animated=i.reduce((function(e,t){return e||t.animated}),!1)})),n.addEventListener("seeked",(function(){t.update(e,t.options),i.dirty=!0}))}return t})):Promise.resolve(r)}}]),t}(_);function ie(e){return(ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function oe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ae(e,t){return!t||"object"!==ie(t)&&"function"!=typeof t?ue(e):t}function se(e){return(se=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ue(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function le(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&fe(e,t)}function fe(e,t){return(fe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ce(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function he(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.Unknown=0]="Unknown",e.Uniform1i="uniform1i",e.Uniform2i="uniform2i",e.Uniform3i="uniform3i",e.Uniform4i="uniform4i",e.Uniform1f="uniform1f",e.Uniform2f="uniform2f",e.Uniform3f="uniform3f",e.Uniform4f="uniform4f",e.Uniform1iv="uniform1iv",e.Uniform2iv="uniform2iv",e.Uniform3iv="uniform3iv",e.Uniform4iv="uniform4iv",e.Uniform1fv="uniform1fv",e.Uniform2fv="uniform2fv",e.Uniform3fv="uniform3fv",e.Uniform4fv="uniform4fv",e.UniformMatrix2fv="uniformMatrix2fv",e.UniformMatrix3fv="uniformMatrix3fv",e.UniformMatrix4fv="uniformMatrix4fv"}(Z||(Z={})),function(e){e[e.Unknown=0]="Unknown",e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Bool=3]="Bool",e[e.Sampler2D=4]="Sampler2D",e[e.SamplerCube=5]="SamplerCube",e[e.Matrix2fv=6]="Matrix2fv",e[e.Matrix3fv=7]="Matrix3fv",e[e.Matrix4fv=8]="Matrix4fv"}(ee||(ee={}));var ve=[Z.Uniform1i,Z.Uniform2i,Z.Uniform3i,Z.Uniform4i],de=[Z.Uniform1f,Z.Uniform2f,Z.Uniform3f,Z.Uniform4f],me=[Z.Uniform1iv,Z.Uniform2iv,Z.Uniform3iv,Z.Uniform4iv],pe=[Z.Uniform1fv,Z.Uniform2fv,Z.Uniform3fv,Z.Uniform4fv],ge=function e(t){var n=this;ce(this,e),he(this,"method",void 0),he(this,"type",void 0),he(this,"key",void 0),he(this,"values",void 0),he(this,"location",void 0),he(this,"dirty",!0),he(this,"apply",void 0),t&&Object.assign(this,t),this.apply=function(e,t){if(n.dirty){e.useProgram(t);var r=e.getUniformLocation(t,n.key);e[n.method].apply(e,[r].concat(n.values))}}},ye=function(e){function t(e){var n;return ce(this,t),he(ue(n=ae(this,se(t).call(this,e))),"texture",void 0),n}return le(t,e),t}(ge),be=function(e){function t(){var e,n;ce(this,t);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return he(ue(n=ae(this,(e=se(t)).call.apply(e,[this].concat(i)))),"dirty",!1),n}var n,r,i;return le(t,e),n=t,i=[{key:"isDifferent",value:function(e,t){return e.length!==t.length||e.reduce((function(e,n,r){return e||n!==t[r]}),!1)}},{key:"isArrayOfInteger",value:function(e){return e.reduce((function(e,t){return e&&Number.isInteger(t)}),!0)}},{key:"isArrayOfNumber",value:function(e){return e.reduce((function(e,t){return e&&"number"==typeof t}),!0)}},{key:"isArrayOfBoolean",value:function(e){return e.reduce((function(e,t){return e&&"boolean"==typeof t}),!0)}},{key:"isArrayOfTexture",value:function(e){return e.reduce((function(e,t){return e&&ne.isTexture(t)}),!0)}},{key:"isArrayOfSampler2D",value:function(e){return e.reduce((function(e,t){return e&&t.type===ee.Sampler2D}),!0)}},{key:"getType_",value:function(e){var n=ee.Unknown,r=1===e.length&&Array.isArray(e[0])?e[0]:e;return t.isArrayOfNumber(r)?n=ee.Float:t.isArrayOfBoolean(r)?n=ee.Bool:t.isArrayOfTexture(r)&&(n=ee.Sampler2D),n}},{key:"getMethod_",value:function(e,t){var n=Z.Unknown,r=1===t.length&&Array.isArray(t[0]),i=(r?t[0]:t).length,o=i-1;switch(e){case ee.Float:n=r?o<pe.length?pe[o]:Z.Unknown:o<de.length?de[o]:Z.Uniform1fv;break;case ee.Int:case ee.Bool:n=r?o<me.length?me[o]:Z.Unknown:o<ve.length?ve[o]:Z.Uniform1iv;break;case ee.Sampler2D:n=r?Z.Uniform1iv:1===i?Z.Uniform1i:Z.Uniform1iv}return n}},{key:"parseUniform",value:function(e,n){var r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;i=i||t.getType_(n);var o=t.getMethod_(i,n);if(i!==ee.Unknown&&o!==Z.Unknown){if(i===ee.Sampler2D&&o===Z.Uniform1iv)return n[0].map((function(t,n){return new ge({method:o,type:i,key:"".concat(e,"[").concat(n,"]"),values:[t]})}));r=new ge({method:o,type:i,key:e,values:n})}else l.error("Uniforms.parseUniform.Unknown",e,n);return r}}],(r=[{key:"create",value:function(e,t,n,r){var i=new ge({method:e,type:t,key:n,values:r});return this.set(n,i),this.dirty=!0,i}},{key:"createTexture",value:function(e,t){var n;return n=-1!==e.indexOf("]")?new ye({method:Z.Uniform1iv,type:ee.Sampler2D,key:e,values:[[t]]}):new ye({method:Z.Uniform1i,type:ee.Sampler2D,key:e,values:[t]}),this.set(e,n),this.dirty=!0,n}},{key:"update",value:function(e,n,r,i){var o=this.get(r);o&&(o.method!==e||o.type!==n||t.isDifferent(o.values,i))&&(o.method=e,o.type=n,o.values=i,o.dirty=!0,this.dirty=!0)}},{key:"createOrUpdate",value:function(e,t,n,r){this.has(n)?this.update(e,t,n,r):this.create(e,t,n,r)}},{key:"apply",value:function(e,t){for(var n in this.values)this.values[n].apply(e,t)}},{key:"clean",value:function(){for(var e in this.values)this.values[e].dirty=!1;this.dirty=!1}}])&&oe(n.prototype,r),i&&oe(n,i),t}(_);function Ee(e){return(Ee="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Te(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _e(e,t,n){return t&&Te(e.prototype,t),n&&Te(e,n),e}function we(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function xe(e,t){return!t||"object"!==Ee(t)&&"function"!=typeof t?Ae(e):t}function ke(e){return(ke=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ae(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ue(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Re(e,t)}function Re(e,t){return(Re=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Le(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Se=function(e){function t(){var e,n;we(this,t);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return Le(Ae(n=xe(this,(e=ke(t)).call.apply(e,[this].concat(i)))),"vertexString",void 0),Le(Ae(n),"fragmentString",void 0),Le(Ae(n),"backgroundColor",void 0),Le(Ae(n),"workpath",void 0),Le(Ae(n),"onError",void 0),n}return Ue(t,e),t}(p),Pe=function(){function e(){we(this,e),Le(this,"start",void 0),Le(this,"previous",void 0),Le(this,"delay",0),Le(this,"current",0),Le(this,"delta",0),Le(this,"paused",!1),this.start=this.previous=this.now()}return _e(e,[{key:"now",value:function(){return performance.now()}},{key:"play",value:function(){if(this.previous){var e=this.now();this.delay+=e-this.previous,this.previous=e}this.paused=!1}},{key:"pause",value:function(){this.paused=!0}},{key:"next",value:function(){var e=this.now();return this.delta=e-this.previous,this.current=e-this.start-this.delay,this.previous=e,this}}]),e}(),Oe=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return we(this,t),Le(Ae(n=xe(this,ke(t).call(this))),"options",void 0),Le(Ae(n),"canvas",void 0),Le(Ae(n),"gl",void 0),Le(Ae(n),"program",void 0),Le(Ae(n),"timer",void 0),Le(Ae(n),"vertexBuffers",void 0),Le(Ae(n),"rect",void 0),Le(Ae(n),"mouse",{x:0,y:0}),Le(Ae(n),"uniforms",new be),Le(Ae(n),"buffers",new M),Le(Ae(n),"textures",new re),Le(Ae(n),"textureList",[]),Le(Ae(n),"vertexString",void 0),Le(Ae(n),"fragmentString",void 0),Le(Ae(n),"width",void 0),Le(Ae(n),"height",void 0),Le(Ae(n),"devicePixelRatio",void 0),Le(Ae(n),"valid",!1),Le(Ae(n),"animated",!1),Le(Ae(n),"dirty",!0),Le(Ae(n),"visible",!1),Le(Ae(n),"rafId",void 0),e?(n.options=r,n.canvas=e,n.width=0,n.height=0,n.rect=e.getBoundingClientRect(),n.devicePixelRatio=window.devicePixelRatio||1,e.style.backgroundColor=r.backgroundColor||"rgba(0,0,0,0)",n.getShaders_().then((function(e){n.load().then((function(e){n.program&&(n.addListeners_(),n.onLoop())}))}),(function(e){l.log("GlslCanvas.getShaders_.error",e)})),t.items.push(Ae(n)),n):xe(n)}return Ue(t,e),_e(t,[{key:"getShaders_",value:function(){var e=this;return new Promise((function(t,n){var r=e.canvas,o={};r.hasAttribute("data-vertex-url")&&(o.vertex=r.getAttribute("data-vertex-url")),r.hasAttribute("data-fragment-url")&&(o.fragment=r.getAttribute("data-fragment-url")),r.hasAttribute("data-vertex")&&(e.vertexString=r.getAttribute("data-vertex")),r.hasAttribute("data-fragment")&&(e.fragmentString=r.getAttribute("data-fragment")),Object.keys(o).length?Promise.all(Object.keys(o).map((function(t,n){var r=o[t];return i.fetch(r).then((function(n){return"vertex"===t?e.vertexString=n:e.fragmentString=n}))}))).then((function(n){t([e.vertexString,e.fragmentString])})):t([e.vertexString,e.fragmentString])}))}},{key:"addListeners_",value:function(){this.onScroll=this.onScroll.bind(this),this.onClick=this.onClick.bind(this),this.onMove=this.onMove.bind(this),this.onMousemove=this.onMousemove.bind(this),this.onMouseover=this.onMouseover.bind(this),this.onMouseout=this.onMouseout.bind(this),this.onTouchmove=this.onTouchmove.bind(this),this.onTouchend=this.onTouchend.bind(this),this.onTouchstart=this.onTouchstart.bind(this),this.onLoop=this.onLoop.bind(this),window.addEventListener("scroll",this.onScroll),document.addEventListener("mousemove",this.onMousemove,!1),document.addEventListener("touchmove",this.onTouchmove),this.addCanvasListeners_()}},{key:"addCanvasListeners_",value:function(){this.canvas.hasAttribute("controls")&&(this.canvas.addEventListener("click",this.onClick),this.canvas.addEventListener("mouseover",this.onMouseover),this.canvas.addEventListener("mouseout",this.onMouseout),this.canvas.addEventListener("touchstart",this.onTouchstart),this.canvas.hasAttribute("data-autoplay")||this.pause())}},{key:"removeCanvasListeners_",value:function(){this.canvas.hasAttribute("controls")&&(this.canvas.removeEventListener("click",this.onClick),this.canvas.removeEventListener("mouseover",this.onMouseover),this.canvas.removeEventListener("mouseout",this.onMouseout),this.canvas.removeEventListener("touchstart",this.onTouchstart))}},{key:"removeListeners_",value:function(){window.cancelAnimationFrame(this.rafId),window.removeEventListener("scroll",this.onScroll),document.removeEventListener("mousemove",this.onMousemove),document.removeEventListener("touchmove",this.onTouchmove),this.removeCanvasListeners_()}},{key:"onScroll",value:function(e){this.rect=this.canvas.getBoundingClientRect()}},{key:"onClick",value:function(e){this.toggle(),this.trigger("click",e)}},{key:"onMove",value:function(e,t){var n=this.rect,r=(e-n.left)*this.devicePixelRatio,i=(n.height-(t-n.top))*this.devicePixelRatio;r===this.mouse.x&&i===this.mouse.y||(this.mouse.x=r,this.mouse.y=i,this.trigger("move",this.mouse))}},{key:"onMousemove",value:function(e){this.onMove(e.clientX||e.pageX,e.clientY||e.pageY)}},{key:"onMouseover",value:function(e){this.play(),this.trigger("over",e)}},{key:"onMouseout",value:function(e){this.pause(),this.trigger("out",e)}},{key:"onTouchmove",value:function(e){var t=[].slice.call(e.touches).reduce((function(e,t){return(e=e||{x:0,y:0}).x+=t.clientX,e.y+=t.clientY,e}),null);t&&this.onMove(t.x/e.touches.length,t.y/e.touches.length)}},{key:"onTouchend",value:function(e){this.pause(),this.trigger("out",e),document.removeEventListener("touchend",this.onTouchend)}},{key:"onTouchstart",value:function(e){this.play(),this.trigger("over",e),document.addEventListener("touchend",this.onTouchend),document.removeEventListener("mousemove",this.onMousemove),this.canvas.hasAttribute("controls")&&(this.canvas.removeEventListener("mouseover",this.onMouseover),this.canvas.removeEventListener("mouseout",this.onMouseout))}},{key:"onLoop",value:function(e){this.checkRender(),this.rafId=window.requestAnimationFrame(this.onLoop)}},{key:"setUniform_",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=be.parseUniform(e,t,i);if(Array.isArray(o))be.isArrayOfSampler2D(o)?o.forEach((function(e){return n.loadTexture(e.key,e.values[0],r)})):o.forEach((function(e){return n.uniforms.set(e.key,e.values[0])}));else if(o)switch(o.type){case ee.Sampler2D:this.loadTexture(e,t[0],r);break;default:this.uniforms.set(e,o)}}},{key:"parseTextures_",value:function(e){for(var t,n=this,r=/uniform\s*sampler2D\s*([\w]*);(\s*\/\/\s*([\w|\:\/\/|\.|\-|\_|\?|\&|\=]*)|\s*)/gm;null!==(t=r.exec(e));){var i=t[1],o=t[3];ne.isTextureUrl(o)?this.textureList.push({key:i,url:o}):this.buffers.has(i)||this.textureList.push({key:i,url:null})}this.canvas.hasAttribute("data-textures")&&this.canvas.getAttribute("data-textures").split(",").forEach((function(e,t){var r="u_texture"+t;n.textureList.push({key:r,url:e})}));return this.textureList.length>0}},{key:"createUniforms_",value:function(){var e=this,t=this.gl,n=this.fragmentString,r=t.drawingBufferWidth,i=t.drawingBufferHeight,o=this.timer=new Pe,a=(n.match(/u_delta/g)||[]).length>1,s=(n.match(/u_time/g)||[]).length>1,u=(n.match(/u_date/g)||[]).length>1,l=(n.match(/u_mouse/g)||[]).length>1,f=this.parseTextures_(n);if(this.animated=s||u||l,this.animated?this.canvas.classList.add("animated"):this.canvas.classList.remove("animated"),this.uniforms.create(Z.Uniform2f,ee.Float,"u_resolution",[r,i]),a&&this.uniforms.create(Z.Uniform1f,ee.Float,"u_delta",[o.delta/1e3]),s&&this.uniforms.create(Z.Uniform1f,ee.Float,"u_time",[o.current/1e3]),u){var c=new Date;this.uniforms.create(Z.Uniform4f,ee.Float,"u_date",[c.getFullYear(),c.getMonth(),c.getDate(),3600*c.getHours()+60*c.getMinutes()+c.getSeconds()+.001*c.getMilliseconds()])}for(var h in l&&this.uniforms.create(Z.Uniform2f,ee.Float,"u_mouse",[0,0]),this.buffers.values){var v=this.buffers.values[h];this.uniforms.create(Z.Uniform1i,ee.Sampler2D,v.key,[v.input.index])}f&&(this.textureList.filter((function(e){return e.url})).forEach((function(t){e.setTexture(t.key,t.url,t.options)})),this.textureList=[])}},{key:"updateUniforms_",value:function(){var e=this.gl,t=e.drawingBufferWidth,n=e.drawingBufferHeight;if(this.timer){var r=this.timer.next();if(this.uniforms.update(Z.Uniform2f,ee.Float,"u_resolution",[t,n]),this.uniforms.has("u_delta")&&this.uniforms.update(Z.Uniform1f,ee.Float,"u_delta",[r.delta/1e3]),this.uniforms.has("u_time")&&this.uniforms.update(Z.Uniform1f,ee.Float,"u_time",[r.current/1e3]),this.uniforms.has("u_date")){var i=new Date;this.uniforms.update(Z.Uniform4f,ee.Float,"u_date",[i.getFullYear(),i.getMonth(),i.getDate(),3600*i.getHours()+60*i.getMinutes()+i.getSeconds()+.001*i.getMilliseconds()])}if(this.uniforms.has("u_mouse")){var o=this.mouse;this.uniforms.update(Z.Uniform2f,ee.Float,"u_mouse",[o.x,o.y])}for(var a in this.buffers.values){var s=this.buffers.values[a];this.uniforms.update(Z.Uniform1i,ee.Sampler2D,s.key,[s.input.index])}for(var u in this.textures.values){var l=this.textures.values[u];l.tryUpdate(e),this.uniforms.update(Z.Uniform1i,ee.Sampler2D,l.key,[l.index])}}}},{key:"isVisible_",value:function(){var e=this.rect;return e.top+e.height>0&&e.top<(window.innerHeight||document.documentElement.clientHeight)}},{key:"isAnimated_",value:function(){return(this.animated||this.textures.animated)&&!this.timer.paused}},{key:"isDirty_",value:function(){return this.dirty||this.uniforms.dirty||this.textures.dirty}},{key:"sizeDidChanged_",value:function(){var e=this.gl,t=Math.ceil(this.canvas.clientWidth),n=Math.ceil(this.canvas.clientHeight);if(this.width!==t||this.height!==n){this.width=t,this.height=n;var r=Math.ceil(t*this.devicePixelRatio),i=Math.ceil(n*this.devicePixelRatio);for(var o in this.canvas.width=r,this.canvas.height=i,this.buffers.values){this.buffers.values[o].resize(e,r,i)}return this.rect=this.canvas.getBoundingClientRect(),this.trigger("resize"),!0}return!1}},{key:"load",value:function(e,t){var n=this;return Promise.all([y.getIncludes(e||this.fragmentString),y.getIncludes(t||this.vertexString)]).then((function(e){return n.fragmentString=e[0],n.vertexString=e[1],n.createContext_()}))}},{key:"getContext_",value:function(){var e=this.vertexString,t=this.fragmentString;if(this.vertexString=y.getVertex(e,t),this.fragmentString=y.getFragment(e,t),y.versionDiffers(this.gl,e,t)&&(this.destroyContext_(),this.swapCanvas_(),this.uniforms=new be,this.buffers=new M,this.textures=new re,this.textureList=[]),!this.gl){var n=y.tryInferContext(e,t,this.canvas,this.options,this.options.onError);if(!n)return;this.gl=n}return this.gl}},{key:"createContext_",value:function(){var e=this.getContext_();if(e){var t,n;try{t=y.createShader(e,this.vertexString,e.VERTEX_SHADER),(n=y.createShader(e,this.fragmentString,e.FRAGMENT_SHADER))?this.valid=!0:(n=y.createShader(e,m,e.FRAGMENT_SHADER),this.valid=!1)}catch(e){return this.trigger("error",e),!1}var r=y.createProgram(e,[t,n]);if(e.useProgram(r),e.deleteShader(t),e.deleteShader(n),this.program=r,this.valid){try{this.buffers=M.getBuffers(e,this.fragmentString,this.vertexString)}catch(e){return this.valid=!1,this.trigger("error",e),!1}this.vertexBuffers=y.createVertexBuffers(e,r),this.createUniforms_()}return this.trigger("load",this),this.valid}}},{key:"test",value:function(e,t){var n=this;return new Promise((function(r,i){var o=n.vertexString,a=n.fragmentString,s=n.timer.paused,u=n.gl.getExtension("EXT_disjoint_timer_query"),l=u.createQueryEXT(),f=n.valid;(e||t)&&(n.load(e,t),f=n.valid,n.render()),n.timer.paused=!0,u.beginQueryEXT(u.TIME_ELAPSED_EXT,l),n.render(),u.endQueryEXT(u.TIME_ELAPSED_EXT);!function i(){n.render();var c=u.getQueryObjectEXT(l,u.QUERY_RESULT_AVAILABLE_EXT),h=n.gl.getParameter(u.GPU_DISJOINT_EXT);if(c&&!h){var v={wasValid:f,fragment:e||n.fragmentString,vertex:t||n.vertexString,timeElapsedMs:u.getQueryObjectEXT(l,u.QUERY_RESULT_EXT)/1e6};n.timer.paused=s,(e||t)&&n.load(a,o),r(v)}else window.requestAnimationFrame(i)}()}))}},{key:"destroyContext_",value:function(){var e=this.gl;for(var t in e.useProgram(null),this.program&&e.deleteProgram(this.program),this.buffers.values){this.buffers.values[t].destroy(e)}for(var n in this.textures.values){this.textures.values[n].destroy(e)}this.buffers=null,this.textures=null,this.uniforms=null,this.program=null,this.gl=null}},{key:"swapCanvas_",value:function(){var e=this.canvas,t=e.cloneNode();e.parentNode.replaceChild(t,e),this.canvas=t,this.addCanvasListeners_()}},{key:"destroy",value:function(){this.removeListeners_(),this.destroyContext_(),this.animated=!1,this.valid=!1,t.items.splice(t.items.indexOf(this),1)}},{key:"loadTexture",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.valid?this.textures.createOrUpdate(this.gl,e,t,this.buffers.count,r,this.options.workpath).then((function(t){var r=t.index;n.uniforms.createTexture(e,r).texture=t;var i=-1!==e.indexOf("[")?e.replace("[","Resolution["):e+"Resolution";n.uniforms.create(Z.Uniform2f,ee.Float,i,[t.width,t.height]);return t}),(function(r){var i=Array.isArray(r.path)?r.path.map((function(e){return e.error?e.error.message:""})).join(", "):r.message;l.log("GlslCanvas.loadTexture.error",e,t,i),n.trigger("textureError",{key:e,urlElementOrData:t,message:i})})):this.textureList.push({key:e,url:t,options:r})}},{key:"setTexture",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.setUniform_(e,[t],n)}},{key:"setUniform",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return this.setUniform_(e,n)}},{key:"setUniformOfInt",value:function(e,t){return this.setUniform_(e,t,null,ee.Int)}},{key:"setUniforms",value:function(e){for(var t in e)this.setUniform(t,e[t])}},{key:"pause",value:function(){this.valid&&(this.timer.pause(),this.canvas.classList.add("paused"),this.trigger("pause"))}},{key:"play",value:function(){this.valid&&(this.timer.play(),this.canvas.classList.remove("paused"),this.trigger("play"))}},{key:"toggle",value:function(){this.valid&&(this.timer.paused?this.play():this.pause())}},{key:"checkRender",value:function(){this.isVisible_()&&(this.sizeDidChanged_()||this.isAnimated_()||this.isDirty_())?(this.render(),this.canvas.classList.add("playing")):this.canvas.classList.remove("playing")}},{key:"render",value:function(){var e=this.gl;if(e){var t=e.drawingBufferWidth,n=e.drawingBufferHeight;for(var r in this.updateUniforms_(),this.buffers.values){var i=this.buffers.values[r];this.uniforms.apply(e,i.program),i.render(e,t,n)}e.useProgram(this.program),this.uniforms.apply(e,this.program),e.viewport(0,0,t,n),e.bindFramebuffer(e.FRAMEBUFFER,null),e.drawArrays(e.TRIANGLES,0,6),this.uniforms.clean(),this.textures.clean(),this.dirty=!1,this.trigger("render",this)}}}],[{key:"version",value:function(){return"0.1.6"}},{key:"of",value:function(e){return t.items.find((function(t){return t.canvas===e}))||new t(e)}},{key:"loadAll",value:function(){return[].slice.call(document.getElementsByClassName("glsl-canvas")).filter((function(e){return e instanceof HTMLCanvasElement})).map((function(e){return t.of(e)}))}}]),t}(G);Le(Oe,"logger",l),Le(Oe,"items",[]),window.GlslCanvas=window.GlslCanvas||Oe,document&&document.addEventListener("DOMContentLoaded",(function(){Oe.loadAll()}))}]);